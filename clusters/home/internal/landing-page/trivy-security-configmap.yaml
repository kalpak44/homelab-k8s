apiVersion: v1
kind: ConfigMap
metadata:
  name: trivy-security-html
  namespace: internal
data:
  index.html: |-
    <!doctype html>
    <html lang="en" class="dark">
    <head>
        <meta charset="UTF-8"/>
        <title>Security Reports</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        
        <script src="https://cdn.tailwindcss.com"></script>
        <script>
            tailwind.config = {
                darkMode: 'class',
                theme: {
                    extend: {
                        animation: {
                            spinSlow: 'spin 1.4s linear infinite',
                            pulseSlow: 'pulse 2s ease-in-out infinite'
                        }
                    }
                }
            }
        </script>
        
        <style>
            .mono { font-variant-ligatures: none; }
        </style>
    </head>

    <body class="bg-zinc-950 text-zinc-100 min-h-screen">

    <!-- LOADER -->
    <div id="loader" class="fixed inset-0 z-50 flex items-center justify-center bg-zinc-950">
        <div class="text-center">
            <div class="h-14 w-14 mx-auto rounded-full border-4 border-zinc-700 border-t-red-500 animate-spinSlow"></div>
            <p id="loaderText" class="mt-6 text-sm text-zinc-400 animate-pulseSlow">
                Loading security report…
            </p>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">
        
        <!-- HEADER -->
        <header class="flex justify-between items-end gap-4">
            <div>
                <h1 class="text-3xl font-semibold">Security Reports</h1>
                <p id="subtitle" class="text-sm text-zinc-400 mt-1">—</p>
            </div>
            <div class="flex gap-2">
                <a href="./reports.json" target="_blank"
                   class="rounded-lg border border-zinc-800 bg-zinc-900 px-3 py-2 text-sm hover:bg-zinc-800">
                    View JSON
                </a>
            </div>
        </header>
        
        <!-- FILTERS -->
        <section class="mt-6 flex flex-wrap gap-3 items-center">
            <input id="search"
                   placeholder="Search CVE / package / image…"
                   class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm w-72"/>
            
            <select id="severityFilter"
                    class="bg-zinc-900 border border-zinc-800 rounded-lg px-3 py-2 text-sm">
                <option value="">All severities</option>
                <option>CRITICAL</option>
                <option>HIGH</option>
                <option>MEDIUM</option>
                <option>LOW</option>
                <option>UNKNOWN</option>
            </select>
        </section>
        
        <!-- NAMESPACE TABS -->
        <div id="tabs" class="mt-6 flex gap-2 flex-wrap"></div>
        
        <!-- TABLE -->
        <div class="mt-4 overflow-hidden rounded-2xl border border-zinc-800 bg-zinc-900/40">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-zinc-950/50 text-xs uppercase text-zinc-400">
                    <tr>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('severity')">Severity</th>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('cve')">CVE</th>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('pkg')">Package</th>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('installed')">Installed</th>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('fixed')">Fixed</th>
                        <th class="px-4 py-3 cursor-pointer" onclick="sortBy('image')">Image</th>
                    </tr>
                    </thead>
                    <tbody id="tbody" class="divide-y divide-zinc-800"></tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        const tbody = document.getElementById('tbody');
        const tabs = document.getElementById('tabs');
        
        let all = [];
        let currentNS = '';
        let sortKey = '';
        let sortDir = 1;
        
        function hideLoader() {
            loader.classList.add('opacity-0');
            setTimeout(() => loader.remove(), 400);
        }
        
        function badge(sev) {
            const c = {
                CRITICAL: 'bg-red-950 text-red-300 border-red-900',
                HIGH: 'bg-orange-950 text-orange-300 border-orange-900',
                MEDIUM: 'bg-amber-950 text-amber-300 border-amber-900',
                LOW: 'bg-lime-950 text-lime-300 border-lime-900',
                UNKNOWN: 'bg-sky-950 text-sky-300 border-sky-900'
            };
            return `<span class="rounded-full border px-2 py-0.5 text-xs ${c[sev] || c.UNKNOWN}">${sev}</span>`;
        }
        
        function sortBy(k) {
            sortDir = sortKey === k ? -sortDir : 1;
            sortKey = k;
            render();
        }
        
        function render() {
            tbody.innerHTML = '';
            
            const q = document.getElementById('search').value.toLowerCase();
            const sev = document.getElementById('severityFilter').value;
            
            let rows = all.filter(v =>
                v.ns === currentNS &&
                (!sev || v.severity === sev) &&
                (!q || v.search.includes(q))
            );
            
            if (sortKey) {
                rows.sort((a,b) =>
                    (a[sortKey] > b[sortKey] ? 1 : -1) * sortDir
                );
            }
            
            for (const v of rows) {
                tbody.innerHTML += `
            <tr class="hover:bg-zinc-950/40">
              <td class="px-4 py-3">${badge(v.severity)}</td>
              <td class="px-4 py-3 mono">${v.cve}</td>
              <td class="px-4 py-3">${v.pkg}</td>
              <td class="px-4 py-3 mono">${v.installed}</td>
              <td class="px-4 py-3 mono">${v.fixed}</td>
              <td class="px-4 py-3 text-xs text-zinc-400">${v.image}</td>
            </tr>`;
            }
        }
        
        async function load() {
            loaderText.textContent = 'Fetching reports.json…';
            const res = await fetch('./reports.json', { cache: 'no-store' });
            const json = await res.json();
            
            const nsSet = new Set();
            
            for (const item of json.items || []) {
                const ns = item.metadata?.namespace || 'default';
                const image = `${item.report?.artifact?.repository}:${item.report?.artifact?.tag}`;
                
                nsSet.add(ns);
                
                for (const v of item.report?.vulnerabilities || []) {
                    const sev = (v.severity || 'UNKNOWN').toUpperCase();
                    all.push({
                        ns,
                        severity: sev,
                        cve: v.vulnerabilityID || '—',
                        pkg: v.resource || '—',
                        installed: v.installedVersion || '—',
                        fixed: v.fixedVersion || '—',
                        image,
                        search: `${v.vulnerabilityID} ${v.resource} ${image}`.toLowerCase()
                    });
                }
            }
            
            [...nsSet].sort().forEach((ns,i) => {
                const b = document.createElement('button');
                b.textContent = ns;
                b.className = 'px-3 py-1.5 rounded-lg border border-zinc-800 bg-zinc-900 text-sm hover:bg-zinc-800';
                b.onclick = () => {
                    currentNS = ns;
                    [...tabs.children].forEach(x=>x.classList.remove('bg-zinc-800'));
                    b.classList.add('bg-zinc-800');
                    render();
                };
                if (i === 0) {
                    currentNS = ns;
                    b.classList.add('bg-zinc-800');
                }
                tabs.appendChild(b);
            });
            
            document.getElementById('subtitle').textContent =
                `Namespaces: ${nsSet.size} • Vulnerabilities: ${all.length}`;
            
            hideLoader();
            render();
        }
        
        document.getElementById('search').oninput = render;
        document.getElementById('severityFilter').onchange = render;
        
        load();
    </script>

    </body>
    </html>
