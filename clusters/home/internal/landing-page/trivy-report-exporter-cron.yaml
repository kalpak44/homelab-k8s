apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-report-exporter
  namespace: internal
spec:
  schedule: "*/30 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: trivy-report-exporter
          restartPolicy: OnFailure

          volumes:
            - name: work
              emptyDir: {}
            - name: reports
              persistentVolumeClaim:
                claimName: trivy-reports

          containers:
            - name: kubectl-exporter
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  kubectl get vulnerabilityreports -A -o json > /work/reports.json
              volumeMounts:
                - name: work
                  mountPath: /work

            - name: trivy-converter
              image: aquasec/trivy:0.50.1
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  trivy convert \
                    --format template \
                    --template "@/contrib/html.tpl" \
                    /work/reports.json \
                    > /reports/index.html
              volumeMounts:
                - name: work
                  mountPath: /work
                - name: reports
                  mountPath: /reports
