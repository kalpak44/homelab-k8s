apiVersion: batch/v1
kind: CronJob
metadata:
  name: trivy-report-exporter
  namespace: internal
spec:
  schedule: "*/30 * * * *"
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 3
      template:
        spec:
          serviceAccountName: trivy-report-exporter
          restartPolicy: OnFailure

          volumes:
            - name: reports
              persistentVolumeClaim:
                claimName: trivy-reports

          containers:
            - name: kubectl-exporter
              image: bitnami/kubectl:latest
              command:
                - /bin/sh
                - -c
                - |
                  set -e
                  kubectl get vulnerabilityreports -A -o json \
                    > /reports/reports.json
                  sleep 30000
              volumeMounts:
                - name: reports
                  mountPath: /reports
